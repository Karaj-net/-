#Управление_данными 
25.03.2025
# Язык определения данных
## Создание, изменение и удаление таблиц
### Подразделы SQL

| SELECT                     | Язык запросов (Queries)                 |
| -------------------------- | --------------------------------------- |
| CREATE<br>ALTER<br>DROP    | Язык определения данных (DDL)           |
| INSERT<br>UPDATE<br>DELETE | Язык манипулирования данными (DML)      |
| GRANT<br>REVOKE            | Язык управления доступа к данным (DCL)  |
| COMMIT<br>ROLLBACK         | Язык управления  <br>транзакциями (TCL) |
### Пример простой схемы БД
Столбцы таблицы **Salespeople (Продавцы)**

| Столбец | Описание                                                           |
| ------- | ------------------------------------------------------------------ |
| snum    | Уникальный номер, присваиваемый каждому продавцу (номер служащего) |
| sname   | Фамилия продавца                                                   |
| city    | Город, где находится продавец, т. е. один из офисов компании.      |
| comm    | Комиссионное вознаграждение продавца в десятичной форме            |
![[Pasted image 20250325092035.png]]
Столбцы таблицы Customers (Покупатели)

| Столбец | Описание                                                                                                                           |
| ------- | ---------------------------------------------------------------------------------------------------------------------------------- |
| сnum    | Уникальный номер, присваиваемый каждому покупателю                                                                                 |
| сname   | Фамилия покупателя                                                                                                                 |
| city    | Город, где находится покупатель. Это один из офисов компании, а не место проживания<br><br>покупателя                              |
| rating  | Числовой код, который показывает уровень предпочтения для покупателя. NULL обозначает покупателя, которому еще не присвоен рейтинг |
| snum    | Номер продавца (из таблицы Salespeople), прикрепленного к данному покупателюA                                                      |
|         |                                                                                                                                    |
![[Pasted image 20250325092237.png]]
Столбцы таблицы Orders (Заказы)

| Столбец | Описание                                                                                                                                         |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------------------ |
| onum    | Уникальный номер, присваиваемый каждой покупке                                                                                                   |
| amt     | Сумма покупки                                                                                                                                    |
| odate   | Дата покупки                                                                                                                                     |
| cnum    | Номер покупателя (из таблицы Customers), делающего покупку                                                                                       |
| snum    | Номер продавца (из таблицы Salespeople), совершившего продажу. Обычно это продавец, прикрепленный к покупателю в таблице Customers, но не всегда |
![[Pasted image 20250325092423.png]]
![[Pasted image 20250325092439.png]]
Команды *Data Definition Language (DDL)* для работы с таблицами:
- **CREATE TABLE** — создание таблицы
- **ALTER TABLE** — изменение таблицы
- **DROP TABLE** — удаление таблицы

### Создание таблицы
Таблицы создаются с помощью команды **CREATE TABLE**, которая:
- формирует пустую таблицу, не содержащую строк
- определяет таблицу как набор поименованных столбцов, расположенных в указанном порядке
- задает типы данных и размеры столбцов
- задает ограничения

Упрощенный синтаксис оператора **CREATE TABLE**:
```MySQL
CREATE TABLE [схема.]имя_таблицы

({имя_столбца   тип_данных[(размер)]}.,..);
```
Пример создания таблицы:
```MySQL
CREATE TABLE Salespeople

(snum  NUMBER(10),

 sname CHAR(10),

 city  CHAR(10),

 comm  NUMBER(18,2));
```

### Типы данных
![[Pasted image 20250325092820.png]]

### Проверка создания таблицы
•Команда **DESCRIBE** выводит описание таблицы
```MySQL
DESCRIBE имя_таблицы
```
Вывод таблиц, принадлежащих пользователю
```MySQL
SELECT * FROM user_tables
```
### Присвоение значений по умолчанию
*Значение по умолчанию (default value, default)* — это величина, которая **автоматически** вставляется в столбец таблицы в случае, если значение данного столбца не указано в операторе **INSERT**.

Использование **DEFAULT** для установки значения по умолчанию для столбца:
```MySQL
CREATE TABLE  Salespeople

(snum  NUMBER(10),

 sname CHAR(10),

 city  CHAR(10) DEFAULT 'New York',

 comm  NUMBER(18,2);
```
### Изменение таблицы
Оператор  **ALTER TABLE**  может:
- Переименовывать таблицу
- Добавлять/Изменять/Удалять *столбец/столбцы*
- Добавлять/Удалять *ограничение к таблице*
- Добавлять/Удалять к столбцу *значение по умолчанию*

Упрощенный синтаксис оператора **ALTER TABLE**
***MS SQL Server***:
```MySQL
ALTER TABLE имя таблицы

  {ADD определение столбца}

| {ALTER COLUMN имя столбца  тип данных

  [NULL | NOT NULL]}

| {DROP COLUMN имя столбца)

| {ADD определение ограничения на таблицу)

| {DROP [CONSTRAINT] имя ограничения);
```
### Переименование таблицы
Простейший синтаксис переименования таблицы:
```MySQL
ALTER TABLE table_name

RENAME TO new_table_name;
```
Пример переименования таблицы:
```MySQL
ALTER TABLE suppliers

RENAME TO vendors;
```

```MySQL

```
## Ограничение значение данных
**Ограничения (constraints)** — это элементы определения таблицы, ограничивающие значения, которые можно вводить в ее столбцы (поддержка целостности)

### Объявление ограничений
При создании (а также при изменении) таблицы можно наложить ограничения на значения, которые разрешается вводить в ее столбцы:
- **Ограничения на столбец** (column constraints) действуют только на отдельные столбцы
- **Ограничения на таблицу** (table constraints) применяются к группам из одного и более столбцов

### Типы ограничений
- NOT NULL — исключение NULL-значений (обязательность значений) (только для отдельного столбца!)
- PRIMARY KEY — указание первичного ключа
- UNIQUE — обеспечение уникальности значений
- CHECK — проверка значений столбцов (условие на значение)
- FOREIGN KEY и REFERENCES — обеспечение ссылочной целостности для группы столбцов таблицы или отдельного столбца

### Объявление ограничений
Синтаксис оператора  CREATE TABLE с указанием ограничений:
```MySQL
CREATE TABLE  имя таблицы

({имя столбца   тип данных  [ограничение на столбец]}...,

 [ограничение на таблицу

  (имя столбца .,..).,..]

);
```

### Исключение NULL-значений
**NULL** — это неопределенное значение, которым отмечаются ячейки таблицы, *не имеющие значения*.

Использование ограничения *NOT NULL*:
```MySQL
CREATE TABLE  Salespeople

(snum  NUMBER(10)  NOT NULL,

 sname CHAR(10) NOT NULL,

 city  CHAR(10),

 comm  NUMBER(18,2));
```

### Указание первичного ключа
Использование ограничения **PRIMARY KEY** для определения одного столбца в качестве первичного ключа таблицы:
```MySQL
CREATE TABLE  Salespeople

(snum  NUMBER(10) PRIMARY KEY,

 sname CHAR(10) NOT NULL,

 city  CHAR(10),

 comm  NUMBER(18,2));
```

### Указание первичного ключа
Использование ограничения **PRIMARY KEY** для определения группы столбцов в качестве составного первичного ключа таблицы:
```MySQL
CREATE TABLE Namefield

(firstname CHAR(10),

 lastname  CHAR(10),

 city      CHAR(10),

 PRIMARY KEY (firstname, lastname));
```

### Обеспечение уникальности значений
Отличия между ограничениями  
*UNIQUE* и *PRIMARY KEY*:
- Таблица может содержать ограничение **PRIMARY KEY** только для одного столбца или одной группы столбцов в отличие от **UNIQUE**
- Столбцы с **PRIMARY KEY** не могут содержать **NULL**, а для **UNIQUE** это допустимо
- По-разному взаимодействуют с ограничением **FOREIGN KEY**

Обеспечение уникальности значений для отдельного столбца с помощью UNIQUE:
```MySQL
CREATE TABLE  Salespeople

(snum  NUMBER(10)  PRIMARY KEY,

 sname CHAR(10) NOT NULL UNIQUE,

 city  CHAR(10),

 comm  NUMBER(18,2));
```

### Проверка значений столбцов
Использование ограничения **CHECK** для проверки значений отдельного столбца:
```MySQL
CREATE TABLE  Salespeople

(snum  NUMBER(10)  PRIMARY KEY,

 sname CHAR(10) NOT NULL  UNIQUE,

 city  CHAR(10),

 comm  NUMBER(18,2)  CHECK (comm < 1));
```
Любая попытка занести в этот столбец значение, которое делает предикат **ложным**, будет отклонена.

Использование **CHECK** для задания набора допустимых для столбца значений:
```MySQL
CREATE TABLE  Salespeople

(snum  NUMBER(10) PRIMARY KEY,

 sname CHAR(10) NOT NULL  UNIQUE,

 city  CHAR(10) CHECK (city IN 

  ('London', 'New York', 'Moscow')),

 comm  NUMBER(18,2)  CHECK (comm < 1));
```

Использование ограничения **CHECK** для проверки значений нескольких столбцов:
```MySQL
CREATE TABLE  Salespeople

(snum  NUMBER(10) PRIMARY KEY,

 sname CHAR(10) NOT NULL  UNIQUE,

 city  CHAR(10),

 comm  NUMBER(18,2),

 CHECK (comm < .15 OR city = 'Moscow'));
```

### Просмотр ограничений таблицы
•Используйте системное представление *user_constraints*
```MySQL
SELECT * FROM user_constraints

WHERE table_name = 'ИМЯ_ТАБЛИЦЫ';
```
### Именование ограничений
Пример именованного ограничения:
```MySQL
CREATE TABLE  Salespeople

(snum NUMBER(10) PRIMARY KEY,

 sname CHAR(10) NOT NULL  UNIQUE,

 city  CHAR(10),

 comm  DECIMAL(18,2),

 CONSTRAINT LuckyMoscow CHECK  (comm < .15 OR city = 'Moscow'));
```

### Правила именований ограничений
- Используйте ключевое слово *CONSTRAINT* для именования ограничений
- Имя ограничения должно быть уникальным среди всех принадлежащих вам имен ограничений
- **Старайтесь всегда давать имена ограничениям**
- Если вы не специфицируете имя ограничения, ORACLE сам назначает имя

### Добавление/удаление ограничений
•Добавление именованного ограничения :
```MySQl
ALTER TABLE Salespeople     
ADD CONSTRAINT salespeople_uk UNIQUE sname;
```
•Удаление именованного ограничения из таблицы:
```MySQL
ALTER TABLE Salespeople     
DROP CONSTRAINT LuckyMoscow;
```
## Поддержание ссылочной целостности
SQL поддерживает ссылочную целостность с помощью ограничения **FOREIGN KEY**:
- сужает диапазон вводимых значений, чтобы внешний ключ и его родительский ключ удовлетворяли принципам ссылочной целостности
- отбрасывает значения, которые отсутствуют в родительском ключе
- влияет на возможность изменения и удаления значений родительского ключа

### Объявление внешних ключей
Синтаксис ограничения **FOREIGN KEY**, применяемого к таблице:
```MySQL
FOREIGN KEY список столбцов    REFERENCES таблица [список столбцов]
```
- синтаксис можно использовать как в операторе **CREATE TABLE**, так и в **ALTER TABLE**
- Два списка столбцов — для внешнего и родительского ключей — должны быть **совместимы**

Использование ограничения **FOREIGN KEY**, применяемого к столбцу:
```MySQL
CREATE TABLE  Customers

(cnum   NUMBER(10) PRIMARY KEY,

 cname  CHAR(10),

 city   CHAR(10),

 rating NUMBER(10),

 snum   NUMBER(10) REFERENCES                   Salespeople(snum)  
);
```
Использование ограничения FOREIGN KEY, применяемого к столбцу:
```MySQL
CREATE TABLE  Customers

(cnum   NUMBER(10) PRIMARY KEY,

 cname  CHAR(10),

 city   CHAR(10),

 rating NUMBER(10),

 snum   NUMBER(10),

 FOREIGN KEY (snum)         REFERENCES Salespeople(snum));
```
В ограничении **FOREIGN KEY** можно опустить список столбцов родительского ключа, если этот ключ определен с помощью ограничения **PRIMARY KEY**:
```MySQL
CREATE TABLE  Customers

(cnum   NUMBER(10)  PRIMARY KEY,

 cname  CHAR(10),

 city   CHAR(10),

 rating NUMBER(10),

 snum NUMBER(10) REFERENCES Salespeople);
```
### Условия создания REFERENCES
При задании **REFERENCES** должны выполняться два условия:
1. Родительская таблица должна быть создана первой 
2. Колонка родительской таблицы, на которую ссылается внешний ключ должна быть **UNIQUE** или **PRIMARY KEY**. 
3. Таблица может ссылаться на саму себя (выступать родительской для себя самой)

### Использование внешних ключей
Внешний ключ может ссылаться на свою собственную таблицу:
```MySQL
CREATE TABLE Employees

(empno   NUMBER(10)  PRIMARY KEY,

 name    CHAR(10) NOT NULL,

 manager NUMBER(10)  REFERENCES Employees);
```
![[Pasted image 20250325091134.png]]

### Действия, выполняемые по ссылке
Поддержка ссылочной целостности с помощью **действий, выполняемых по ссылке** (referential triggered actions)

Влияния изменений в родительских ключах на внешние ключи:
- Оператор UPDATE — обновление значений родительского ключа
- Оператор DELETE — удаление значений родительского ключа

По стандарту SQL разрешается независимо изменять поведение операторов **UPDATE** и **DELETE**

*Режимы обновления и удаления*:
- CASCADE — каскадное обновление или удаление
- SET NULL — установка NULL-значений
- SET DEFAULT — установка значений по умолчанию
- NO ACTION — ограничение обновления или удаления

Синтаксис по стандарту SQL для указания действий, выполняемых по ссылке:
```MySQL
[ ON UPDATE { CASCADE

 | SET NULL

 | SET DEFAULT

 | NO ACTION } ]

[ ON DELETE { CASCADE
 | SET NULL

 | SET DEFAULT

 | NO ACTION } ]
```

Пример установки режима каскадного удаления:
```MySQL
CREATE TABLE  Customers

(cnum   NUMBER(10) PRIMARY KEY,

 cname  CHAR(10),

 city   CHAR(10),

 rating NUMBER(10),

 snum NUMBER(10) REFERENCES Salespeople

                 ON DELETE CASCADE);
```